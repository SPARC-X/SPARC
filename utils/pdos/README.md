# calculate_pdos – PDOS Calculator for SPARC

## Overview
calculate_pdos.py is a Python script that provides a set of tools for processing SPARC output files and calculating **Projected Density of States (PDOS)** for electronic structure analysis. The calculator supports full system PDOS calculation, selective atom analysis, automatic atomic orbital generation, and k-point parallelization for efficient computation of electronic properties from first-principles calculations.

## Prerequisites

Before using the PDOS calculator, ensure you have the following Python packages installed:

- **Python 3.10 or later**
- **Numpy** - Numerical computing library
- **Scipy** - Scientific computing library (includes linalg, interpolate, sparse, special modules)
- **PyYAML** - YAML configuration file parsing


You can install the required packages using pip:

```bash
pip install numpy scipy pyyaml
```


## SPARC Input File Requirements

Before running PDOS calculations, ensure your SPARC input file (`.inpt`) contains the following settings, so that you will get the required `.eigen` and `.psi` files for PDOS calculation:

```bash
PRINT_EIGEN: 1      # Required: Print eigenvalues
PRINT_ORBITAL: 1    # Required: Print wavefunctions for projection
```


The PDOS calculator automatically handles both:
- **Static systems**: Direct PDOS calculation from the provided structure
- **Relaxation final states**: Uses the final relaxed geometry for PDOS calculation

**Important**: Since PDOS requires electronic density projection onto atomic orbitals, both the wavefunction data (`.psi` file) and eigenvalue data (`.eigen` file) are essential and must be generated by setting `PRINT_ORBITAL: 1` and `PRINT_EIGEN: 1` in your SPARC input.



## PDOS File Requirements

For a given `sparc_path` like `examples/Al_FCC/Al`, the script will automatically look for the following files:

### Required Files
- **`examples/Al_FCC/Al.out`** - SPARC output file containing most calculation results
- **`examples/Al_FCC/Al.eigen`** - Eigenvalues file
- **`examples/Al_FCC/Al.psi`** - Wavefunction file (generated with `PRINT_ORBITAL: 1`)

### Geometry Files (Choose One)
- **`examples/Al_FCC/Al.static`** - Static geometry file (for static calculations)
- **`examples/Al_FCC/Al.geopt`** - Geometry optimization file (for relaxation final states)

**Note**: The script automatically detects whether to use `.static` or `.geopt` based on file availability. When performing cell relaxation with `relax_flag=2` (fixing atomic fractional coordinates while relaxing cell), the program also automatically looks for the `.ion` file to determine absolute atomic positions. 

### Atomic Orbital Definition

The program requires atomic orbital definitions for projection. Two methods are supported:

#### Method 1: Automatic Generation (Default)
- The program reads pseudopotential paths for each elements from the `.out` file
- Generates atomic orbitals using the corresponding XC functional for each atom

#### Method 2: UPF Files (Optional)
- Place UPF files directly in the SPARC output directory
- Use naming convention: `Element.upf` (e.g., `Al.upf`, `Si.upf`)
- Program prioritizes UPF files over automatic generation if UPF files are provided
- **Hybrid approach**: You can mix both methods - use UPF files for some atoms and automatic generation for others
- **UPF file sources**: Pre-computed UPF files are available at [SPMS-psps repository](https://github.com/SPARC-X/SPMS-psps/tree/master/upf) for various elements and exchange-correlation functionals 




## Usage

### Method 1: Simple Mode (Default Settings)

The simplest way to run PDOS calculation with default parameters:

```bash
python calculate_pdos.py --path=path_to_sparc_output_dir
```

This method performs full PDOS calculation for all atoms and orbitals using default settings, and automatically creates output in the `PDOS_output` directory. The default settings will be detailed in the Configuration File Format section below.






### Method 2: Using Configuration File

For advanced users who need detailed control over calculation parameters:

```bash
python calculate_pdos.py --config=path_to_yaml_file.yaml
```

This method allows for fine-tuned settings such as k-point parallelization, selective atom PDOS calculation to reduce computation time, custom energy ranges, and other advanced parameters.



## Configuration File Format

The configuration file should be in YAML format with the following parameters:

```yaml
# SPARC output path (directory and base filename)
sparc_path: "examples/Al_FCC/Al"

# Output directory for PDOS results (optional)
output_dir: null  # If null, uses sparc_directory/PDOS_output

# Gaussian broadening width (eV)
gaussian_width: 0.2721140795 # If not specified, set 0.2721140795 by default

# Energy range for plotting (eV)
min_E_plot: 5.0   # If not specified, will be set according to the minimum energy eigenvalues
max_E_plot: 65.0  # If not specified, will be set according to the minimum energy eigenvalues

# Number of energy points for PDOS calculation
N_PDOS: 1000   # If not set, set 1000 by default

# Whether to sum over all the m index for the orbital
sum_over_m_index: False  # False by default

# Full pdos calculation settings (If not set, compute PDOS for all atm's oprbitals)
full_pdos_calculation: True  # True by default
atom_type: ["Al", 13]        # Can be either (a list of) element name(s) or atomic number(s)
atom_index_for_specified_atom_type: [0, 1] # Label the atoms in the same order as in .static/.geopt file

# Whether to use k-point parallelization
k_point_parallelization: True
```

### Parameter Descriptions

- **`sparc_path`** (string, required)  
Path to SPARC output files, consists of directory and base filename (`sparc_directory/base_filename`).
- **`output_dir`** (string, optional)  
Custom output directory. Default: `null` (uses `sparc_directory/PDOS_output`)
- **`gaussian_width`** (float, optional)  
Gaussian broadening width for visualization (in eV). Default: `0.2721140795`
- **`N_PDOS`** (integer, optional)  
Number of energy points for visualization in DOS and PDOS. Default: `1000`
- **`min_E_plot`** (float, optional)  
Minimum energy for visualization (in eV). Default: minimum eigenvalue - 5 × gaussian_width
- **`max_E_plot`** (float, optional)  
Maximum energy for visualization (in eV). Default: maximum eigenvalue + 5 × gaussian_width
- **`sum_over_m_index`** (boolean, optional)  
Sum over magnetic quantum number m for orbitals (e.g., 3px+3py+3pz → 3p). Default: `False`
- **`full_pdos_calculation`** (boolean, optional)  
Compute PDOS for all atoms. If False, requires `atom_type` and `atom_index_for_specified_atom_type`. Default: `True`
- **`atom_type`** (list, optional)  
Atom types to include. Can be element names (e.g., "Al", "Si") or atomic numbers (e.g., 13, 14). Default: All atoms
- **`atom_index_for_specified_atom_type`** (list, optional)  
Specific atom indices (0-indexed). For example, `atom_type=["Al", "Si"]`, `atom_index_for_specified_atom_type=[1, 0]` calculates PDOS for the 2nd Al atom and 1st Si atom. Default: All atoms of specified types.
- **`k_point_parallelization`** (boolean, optional)  
Enable k-point parallel processing. Default: `None` (auto-detect: parallel if k-points > 4, sequential if k-points ≤ 4)
- **`recompute_pdos`** (boolean, optional)  
Whether to recompute the PDOS calculation. Default: `True`
- **`projection_datapath`** (string, optional)  
Path to load pre-computed projection data when `recompute_pdos=False`. Default: None
- **`print_projection_data`** (boolean, optional)  
Whether to print the projection data to file. Default: `False`
- **`orthogonalize_atomic_orbitals`** (boolean, optional)  
Whether to orthogonalize the atomic orbitals. Default: `False`

## Output

The script will create a `PDOS_output` directory (or custom directory if specified) containing:
- `DOS.txt` - Total density of states
- `PDOS.txt` - Projected density of states

## Examples: Single-atom System (Al FCC)
Consider a simple Al FCC system. The `examples/Al_FCC` folder contains SPARC calculation results with the following files:

```
examples/Al_FCC/
├── Al.out      # SPARC output file (required)
├── Al.static   # Static file with atomic positions (required)
├── Al.eigen    # Eigenvalues file (required)
├── Al.psi      # Wavefunction file (required)
├── Al.upf      # Aluminum UPF file (optional, for custom atomic orbitals)
├── other_files...   # Other files in the folder (will be ignored)
```

**Note**: The folder may contain other files, which will not affect the PDOS calculation as the program automatically ignores them. The program will:
- Use the provided UPF file (`Al.upf`) as atomic basis sets for projection for all Al atoms
- If UPF files are not provided, the program will read pseudopotential paths from the `.out` file and use the built-in generator to create default atomic orbitals
- Perform PDOS calculations for all Al atoms and their orbitals

#### Full System PDOS Calculation with default parameters:
```bash
python calculate_pdos.py --path=examples/Al_FCC/Al
```

Or equivalently using configuration file:
```yaml
# config_Al_FCC.yaml
sparc_path: "examples/Al_FCC/Al"
gaussian_width: 0.2721140795
min_E_plot: 5.0
max_E_plot: 65.0
N_PDOS: 1000
sum_over_m_index: False
full_pdos_calculation: True
```

```bash
python calculate_pdos.py --config=config_Al_FCC.yaml
```

## Output Files and Results Discussion

For the provided Al FCC example, the program generates output files that can be analyzed as follows:

### DOS.txt
- **Column 1**: Energy levels (in eV)
- **Column 2**: Total electron density projection, representing the occupied states of the system at different energy levels (states/eV)

This file characterizes the overall electronic structure of the system by showing how many electronic states are available at each energy level.

```yaml
# DOS.txt
Energy(eV)   DOS
5.0000000000 0.0000000000
5.0600600601 0.0000000000
5.1201201201 0.0000000000
5.1801801802 0.0000000000
5.2402402402 0.0000000000
5.3003003003 0.0000000000
...
```


### PDOS.txt
The PDOS file contains detailed metadata and projected density of states data. The file structure includes:

**Metadata Section**:
- **Basic calculation info**: Fermi level, broadening, grid points, energy range
- **System info**: Number of bands, k-points, atom types, orbitals
- **Calculation parameters**: M-index summation, orbital orthogonalization
- **Atom-specific info**: Atom type, position, PDOS units

**Data Section**:
- **Energy column**: Energy levels (in eV)
- **Orbital columns**: PDOS values for each orbital

```yaml
# PDOS.txt structure
:Description: 
:Desc_PDOS: Projected density of states for each orbital. Unit=states/eV
:Desc_FERMI_LEVEL: Fermi level energy. Unit=eV
:Desc_BROADENING: Gaussian broadening parameter for DOS calculation. Unit=eV
...

:BASIC_INFO:
:FERMI_LEVEL: 32.432
:BROADENING: 0.272
...

:PDOS_INFO:
    :ATOM_TYPE: Al
    :ATOMIC_NUMBER: 13
    :ATOM_INDEX: 0
    :ATOM_POSITION_CARTESIAN: [0. 0. 0.]
    :ATOM_POSITION_FRACTIONAL: [0. 0. 0.]
    :PDOS_UNIT: states/eV
    :HEADER_FORMAT: (nl,m)
	Energy(eV)   	(3s, m=0)    	(3p, m=-1)   	(3p, m=0)    	(3p, m=1)   
	5.0000000000 	0.0000000000 	0.0000000000 	0.0000000000 	0.0000000000
	5.0600600601 	0.0000000000 	0.0000000000 	0.0000000000 	0.0000000000
	...
```


## Python Class Interface

In addition to the command-line interface, the PDOS calculation can also be accessed programmatically by importing the `PDOSCalculator` class. This allows users to customize workflows, post-process results, or integrate PDOS calculations into larger pipelines.

## Example Usage: Al FCC System
```python
from calculate_pdos import PDOSCalculator

# Example system: Al FCC
upf_fname_list = [
    './examples/Al_FCC/Al.upf',  # Optional UPF file
    # If no UPF files provided, program will use built-in generator
]

output_fname = './examples/Al_FCC/Al.out'
static_fname = './examples/Al_FCC/Al.static'
eigen_fname  = './examples/Al_FCC/Al.eigen'
psi_fname    = './examples/Al_FCC/Al.psi'
out_dirname  = './examples/Al_FCC/PDOS_output'

# Initialize PDOSCalculator
pdos_calculator = PDOSCalculator(
    upf_fname_list = upf_fname_list,  # Optional: can be None for automatic generation
    output_fname = output_fname,
    eigen_fname = eigen_fname,
    static_fname = static_fname,
    psi_fname = psi_fname,
    out_dirname = out_dirname,
    r_cut_max = 15.0,  # Optional: cutoff radius in Bohr
    atomic_wave_function_tol = 1e-5,  # Optional: tolerance for atomic wave functions
    orthogonalize_atomic_orbitals = False,  # Optional: whether to orthogonalize orbitals
    is_relaxation = False,  # Optional: whether from relaxation calculation
    k_point_parallelization = True,  # Optional: enable k-point parallelization
)

# Run the PDOS calculation
E, PDOS, DOS = \
    pdos_calculator.run(
        mu_PDOS = 0.2721140795,  # Gaussian broadening width in eV
        N_PDOS = 1000,  # Number of energy points
        min_E_plot = 5.0,  # Minimum energy in eV (optional, auto-determined if None)
        max_E_plot = 65.0,  # Maximum energy in eV (optional, auto-determined if None)
        sum_over_m_index = False,  # Whether to sum over magnetic quantum number m
        print_projection_data = False,  # Whether to save projection data
    )

# Some downstream analysis
print("E.shape    = ", E.shape)    # (N_PDOS,)
print("DOS.shape  = ", DOS.shape)  # (N_PDOS,)
print("PDOS.shape = ", PDOS.shape) # (N_PDOS, number_of_orbitals)
...

# For selective atom calculation
E_single_atom, PDOS_single_atom, DOS_single_atom = \
    pdos_calculator.run_single_atom(
        atom_type = "Al",  # or atomic number 13
        atom_index_for_specified_atom_type = 0,  # 0-indexed
        mu_PDOS = 0.2721140795,
        N_PDOS = 1000,
        min_E_plot = 5.0,
        max_E_plot = 65.0,
        sum_over_m_index = False,
    )

# Some downstream analysis
print("E_single_atom.shape    = ", E_single_atom.shape)    # (N_PDOS,)
print("DOS_single_atom.shape  = ", DOS_single_atom.shape)  # (N_PDOS,)
print("PDOS_single_atom.shape = ", PDOS_single_atom.shape) # (N_PDOS, number_of_orbitals_for_single_atom)
...

```